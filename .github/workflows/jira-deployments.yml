name: Mark PR as Deployed

on:
    pull_request:
        types:
            - closed
        branches:
            - main
            - qa
            - staging
            - prod

permissions:
    contents: read
    deployments: write

jobs:
    determine-environment:
        runs-on: ubuntu-latest
        outputs:
            environment: ${{ steps.set-env.outputs.environment }}
        steps:
            - name: Set environment dynamically based on the target branch
              id: set-env
              run: |
                  if [[ "${{ github.event.pull_request.base.ref }}" == "main" ]]; then
                    echo "environment=dev" >> $GITHUB_OUTPUT
                  elif [[ "${{ github.event.pull_request.base.ref }}" == "qa" ]]; then
                    echo "environment=qa" >> $GITHUB_OUTPUT
                  elif [[ "${{ github.event.pull_request.base.ref }}" == "staging" ]]; then
                    echo "environment=staging" >> $GITHUB_OUTPUT
                  elif [[ "${{ github.event.pull_request.base.ref }}" == "prod" ]]; then
                    echo "environment=prod" >> $GITHUB_OUTPUT
                  else
                    echo "Needs environment for continue"
                    exit 1
                  fi

    mark-deployment:
        if: github.event.pull_request.merged == true # Only run on merged PRs
        runs-on: ubuntu-latest
        needs: determine-environment # This job depends on the environment determination job
        environment: ${{ needs.determine-environment.outputs.environment }} # Dynamically set environment

        steps:
            - name: Mark deployment in Jira
              uses: actions/github-script@v7
              with:
                  script: |
                      const { owner, repo } = context.repo;
                      const pr = context.payload.pull_request;
                      const ref = pr.merge_commit_sha;
                      const environment = process.env.environment;  // Access environment set by previous step

                      if (environment === 'none') {
                        console.log('No matching environment for this PR.');
                        return;
                      }

                      const deployment = await github.rest.repos.createDeployment({
                        owner,
                        repo,
                        ref: ref,
                        required_contexts: [],
                        environment: environment,
                        auto_merge: false,
                        transient_environment: false,
                        production_environment: false,
                        description: `PR #${pr.number} merged to ${environment} - marked as ${environment} deployment`,
                      });

                      await github.rest.repos.createDeploymentStatus({
                        owner,
                        repo,
                        deployment_id: deployment.data.id,
                        state: 'success',
                        environment_url: '', // Optional: link to staging or preview site
                        description: `Marked as deployed to ${environment}`,
                      });
